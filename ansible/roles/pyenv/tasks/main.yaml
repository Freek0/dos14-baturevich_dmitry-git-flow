- name: Install Pythonh 3.11 
  block:
    - name: Install Python dependencies
      apt:
        name: "{{ item }}"
        state: present
        update_cache: yes
      loop: 
        - python3-dev
        - python3-pip
        - python3-venv

    - name: Install Python using PPA
      apt_repository:
        repo: ppa:deadsnakes/ppa
        state: present
        update_cache: yes

    - name: Install Python 3.11.0 package
      apt:
        name: python3.11
        state: present

    - name: Install Poetry 
      pip:
        name: poetry
        executable: pip3
        state: present

    - name: Execute poetry install
      command: poetry install
      args: 
        chdir: "{{project_dir}}"
    
    - name: Install pyenv dependencies
      apt:
        name: "{{ item }}"
        state: present
      loop:
        - make
        - build-essential
        - libssl-dev
        - zlib1g-dev
        - libbz2-dev
        - libreadline-dev
        - libsqlite3-dev
        - wget
        - curl
        - llvm
        - libncurses5-dev
        - xz-utils
        - tk-dev
        - libxml2-dev
        - libxmlsec1-dev
        - libffi-dev
        - liblzma-dev

    - name: Clone the Pyenv repository
      become_user: bank
      git:
        repo: https://github.com/pyenv/pyenv.git
        dest: /home/bank/.pyenv
        update: yes

    - name: Add pyenv path to PATH
      lineinfile:
        dest: /home/bank/.bashrc
        line: 'export PYENV_ROOT="$HOME/.pyenv"\nexport PATH="$PYENV_ROOT/bin:$PATH"\neval "$(pyenv init --path)"'
        state: present

    - name: install python 3.11.0
      become_user: bank
      shell: ~/.pyenv/bin/pyenv versions | grep -q 3.11.0 || /home/bank/.pyenv/bin/pyenv install 3.11.0
      args:
        executable: /bin/bash
      changed_when: false